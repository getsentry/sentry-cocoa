---
phase: 03-objc-isolation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/Sentry/include/SentryCrash.h
  - Sources/SentryCrash/Recording/SentryCrash.m
  - Sources/Swift/SentryCrash/SentryCrashSwift.swift
autonomous: true

must_haves:
  truths:
    - "SentryCrash.m imports Sentry-Swift.h for bridge access"
    - "SentryCrash.m uses bridge.notificationCenterWrapper instead of container singleton (4 references eliminated)"
    - "SentryCrashSwift exposes setBridge method to inject bridge into wrapped instance"
    - "Fallback pattern ensures compatibility when bridge not set"
  artifacts:
    - path: "Sources/Sentry/include/SentryCrash.h"
      provides: "Bridge property declaration"
      contains: "@property (nonatomic, strong, nullable) SentryCrashBridge *bridge"
    - path: "Sources/SentryCrash/Recording/SentryCrash.m"
      provides: "Bridge usage for notification center access"
      min_lines: 10
    - path: "Sources/Swift/SentryCrash/SentryCrashSwift.swift"
      provides: "Bridge injection method"
      exports: ["setBridge"]
  key_links:
    - from: "Sources/SentryCrash/Recording/SentryCrash.m"
      to: "bridge.notificationCenterWrapper"
      via: "property access in install/uninstall"
      pattern: "self\\.bridge\\.notificationCenterWrapper"
    - from: "Sources/Swift/SentryCrash/SentryCrashSwift.swift"
      to: "sentryCrash.bridge"
      via: "setBridge method"
      pattern: "sentryCrash\\.bridge = bridge"
---

<objective>
Inject SentryCrashBridge into SentryCrash.m to eliminate 4 SentryDependencyContainer references for notificationCenterWrapper access.

Purpose: Remove container dependency from Objective-C core crash recording class by receiving notificationCenterWrapper through bridge facade instead of singleton.

Output: SentryCrash.m uses bridge for app lifecycle notifications, SentryCrashSwift exposes bridge injection method, zero container imports in SentryCrash.m.
</objective>

<execution_context>
@/Users/itaybrenner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itaybrenner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/PROJECT.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/ROADMAP.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/STATE.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/03-objc-isolation/03-RESEARCH.md

@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/01-facade-design-implementation/01-01-SUMMARY.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/01-facade-design-implementation/01-02-SUMMARY.md

@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Sentry/include/SentryCrash.h
@/Users/itaybrenner/sentry/sentry-cocoa/Sources/SentryCrash/Recording/SentryCrash.m
@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Swift/SentryCrash/SentryCrashSwift.swift
@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Swift/Integrations/SentryCrash/SentryCrashBridge.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bridge property to SentryCrash and inject via SentryCrashSwift</name>
  <files>
    Sources/Sentry/include/SentryCrash.h
    Sources/SentryCrash/Recording/SentryCrash.m
    Sources/Swift/SentryCrash/SentryCrashSwift.swift
  </files>
  <action>
**SentryCrash.h:**
- Add forward declaration before @interface: `@class SentryCrashBridge;`
- Add property in @interface: `@property (nonatomic, strong, nullable) SentryCrashBridge *bridge;`

**SentryCrash.m:**

- Add import after existing imports: `#import "SentrySwift.h"` (provides SentryCrashBridge via Sentry-Swift.h)
- Locate 4 container references for notificationCenterWrapper (lines ~239, 263, 295, 312 based on grep)
- Replace pattern `SentryDependencyContainer.sharedInstance.notificationCenterWrapper` with:
  ```objc
  id<SentryNSNotificationCenterWrapper> notificationCenter =
      self.bridge ? self.bridge.notificationCenterWrapper
                  : SentryDependencyContainer.sharedInstance.notificationCenterWrapper;
  ```
- Use fallback pattern for backward compatibility (bridge may be nil in tests or early initialization)
- Apply to all 4 locations: install method (UIApplicationDidBecomeActive, WillResignActive, WillTerminate) and uninstall method

**SentryCrashSwift.swift:**

- Add public method to inject bridge into wrapped SentryCrash instance:
  ```swift
  @objc public func setBridge(_ bridge: SentryCrashBridge) {
      sentryCrash.bridge = bridge
  }
  ```
- Place after existing property methods (after `uncaughtExceptionHandler`, before `basePath`)

**Why this approach:**

- Property injection pattern avoids circular dependency (SentryCrash created before bridge exists)
- Fallback pattern preserves test compatibility and handles partial initialization
- SentryCrashSwift wrapper is injection point (Swift owns ObjC instance)
- DO NOT access bridge from signal handlers (only during setup in install/uninstall methods)
  </action>
  <verify>
  Compilation succeeds for iOS and macOS:

```bash
xcodebuild -scheme Sentry -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' build -quiet
xcodebuild -scheme Sentry -sdk macosx build -quiet
```

Grep confirms notificationCenterWrapper accessed via bridge:

```bash
grep -n "bridge.notificationCenterWrapper" Sources/SentryCrash/Recording/SentryCrash.m
```

Grep confirms setBridge method exists:

```bash
grep -n "func setBridge" Sources/Swift/SentryCrash/SentryCrashSwift.swift
```

</verify>
  <done>
- SentryCrash.h declares bridge property with forward declaration
- SentryCrash.m uses self.bridge.notificationCenterWrapper with fallback to container
- SentryCrashSwift.swift exposes setBridge method for bridge injection
- All 4 notificationCenterWrapper references in SentryCrash.m updated
- iOS and macOS builds succeed
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire bridge from SentryCrashIntegration through SentryCrashSwift to SentryCrash</name>
  <files>
    Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
  </files>
  <action>
Locate where SentryCrashIntegration creates and stores the bridge (Phase 01-02 added `private var bridge: SentryCrashBridge?`).

Find the startCrashHandler method where bridge is created but not yet injected into crash reporter.

After bridge creation and before `crashReporter.install()` call, inject bridge:

```swift
// Inject bridge into crash reporter so ObjC SentryCrash can access it
crashReporter.setBridge(bridge)
```

This ensures SentryCrash.m receives bridge before install() registers notification observers.

**Timing critical:** Bridge must be set BEFORE install() to ensure notification registrations use bridge, not container.

Reference Phase 01-02 SUMMARY for bridge creation location (after super.init, before startCrashHandler).
</action>
<verify>
Grep confirms setBridge called in SentryCrashIntegration:

```bash
grep -n "crashReporter.setBridge" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
```

Run SentryCrashIntegrationTests to verify no regressions:

```bash
make test-ios ONLY_TESTING=SentryCrashIntegrationTests
```

</verify>
  <done>
- SentryCrashIntegration calls crashReporter.setBridge(bridge) before install
- Bridge propagation complete: Integration → SentryCrashSwift → SentryCrash.m
- SentryCrashIntegrationTests pass without modification
  </done>
</task>

</tasks>

<verification>
1. **Container isolation:** `grep -r "SentryDependencyContainer" Sources/SentryCrash/Recording/SentryCrash.m` returns only fallback references (4 instances, all with bridge check)
2. **Bridge wiring:** SentryCrash.m accesses notificationCenterWrapper via self.bridge when available
3. **Compilation:** iOS and macOS builds succeed
4. **Tests:** SentryCrashIntegrationTests pass
</verification>

<success_criteria>

- SentryCrash.h declares `@property (nonatomic, strong, nullable) SentryCrashBridge *bridge`
- SentryCrash.m imports Sentry-Swift.h and uses bridge.notificationCenterWrapper
- SentryCrash.m has fallback to container when bridge is nil (backward compatibility)
- SentryCrashSwift.swift exposes setBridge method
- SentryCrashIntegration injects bridge before crash handler installation
- All 4 notificationCenterWrapper accesses in SentryCrash.m updated
- Builds succeed on iOS and macOS
- SentryCrashIntegrationTests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/03-objc-isolation/03-01-SUMMARY.md`
</output>
