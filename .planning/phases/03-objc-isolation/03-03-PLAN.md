---
phase: 03-objc-isolation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/Swift/SentryCrash/SentryCrashWrapper.swift
autonomous: true

must_haves:
  truths:
    - "SentryCrashWrapper accesses crashedLastLaunch through bridge, not container"
    - "SentryCrashWrapper accesses activeDurationSinceLastCrash through bridge, not container"
    - "All container references eliminated from SentryCrashWrapper (production code)"
  artifacts:
    - path: "Sources/Swift/SentryCrash/SentryCrashWrapper.swift"
      provides: "Container-free crash state access"
      min_lines: 5
  key_links:
    - from: "Sources/Swift/SentryCrash/SentryCrashWrapper.swift"
      to: "bridge.crashReporter"
      via: "property access for crash state"
      pattern: "bridge\\.crashReporter\\.(crashedLastLaunch|activeDurationSinceLastCrash)"
---

<objective>
Complete Swift isolation by eliminating remaining 2 SentryDependencyContainer references from SentryCrashWrapper.swift (crashedLastLaunch and activeDurationSinceLastCrash properties).

Purpose: Remove final container dependencies from SentryCrashWrapper that were deferred from Phase 02 Plan 01. These properties should access crashReporter through bridge, not container singleton.

Output: SentryCrashWrapper fully isolated from container - all production code accesses dependencies through bridge facade.
</objective>

<execution_context>
@/Users/itaybrenner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itaybrenner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/PROJECT.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/ROADMAP.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/STATE.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/03-objc-isolation/03-RESEARCH.md

@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/02-swift-isolation/02-01-SUMMARY.md

@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Swift/SentryCrash/SentryCrashWrapper.swift
@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Swift/Integrations/SentryCrash/SentryCrashBridge.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace remaining container references with bridge access</name>
  <files>
    Sources/Swift/SentryCrash/SentryCrashWrapper.swift
  </files>
  <action>
Locate the two remaining container references (Phase 02-01 deliberately left these for Phase 03):
- Line ~81: `crashedLastLaunch` property accessing `SentryDependencyContainer.sharedInstance().crashReporter.crashedLastLaunch`
- Line ~91: `activeDurationSinceLastCrash` property accessing `SentryDependencyContainer.sharedInstance().crashReporter.activeDurationSinceLastCrash`

**Replace crashedLastLaunch:**

```swift
public var crashedLastLaunch: Bool {
    return bridge.crashReporter.crashedLastLaunch
}
```

**Replace activeDurationSinceLastCrash:**

```swift
public var activeDurationSinceLastCrash: TimeInterval {
    return bridge.crashReporter.activeDurationSinceLastCrash
}
```

**Rationale:**

- Bridge already stored as `private let bridge: SentryCrashBridge` (Phase 02-01)
- Bridge.crashReporter provides SentryCrashSwift wrapper which exposes these properties
- No fallback needed - bridge is always set in production (injected during initialization)
- Phase 02-01 deferred these because they access crashReporter, which needed bridge wiring first

**Verification:**
After changes, grep should find ZERO container references in production code (excluding test-only initializer which is acceptable).
</action>
<verify>
Compilation succeeds for iOS and macOS:

```bash
xcodebuild -scheme Sentry -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' build -quiet
xcodebuild -scheme Sentry -sdk macosx build -quiet
```

Container references eliminated from production code:

```bash
# Should return only test-only initializer reference (line ~36), no production code
grep -n "SentryDependencyContainer" Sources/Swift/SentryCrash/SentryCrashWrapper.swift
```

Bridge access confirmed:

```bash
grep -n "bridge.crashReporter.crashed" Sources/Swift/SentryCrash/SentryCrashWrapper.swift
grep -n "bridge.crashReporter.activeDuration" Sources/Swift/SentryCrash/SentryCrashWrapper.swift
```

</verify>
  <done>
- crashedLastLaunch property accesses bridge.crashReporter.crashedLastLaunch
- activeDurationSinceLastCrash property accesses bridge.crashReporter.activeDurationSinceLastCrash
- Only container reference remaining is test-only initializer (acceptable)
- iOS and macOS builds succeed
  </done>
</task>

<task type="auto">
  <name>Task 2: Run SentryCrashWrapper tests to verify no regressions</name>
  <files></files>
  <action>
Run SentryCrashWrapperTests to ensure crash state properties work correctly with bridge access:

```bash
make test-ios ONLY_TESTING=SentryCrashWrapperTests
```

These tests should pass without modification because:

- Bridge is properly initialized in production initializers (Phase 02-01)
- Test-only initializer still accesses container (preserved for backward compatibility)
- crashedLastLaunch and activeDurationSinceLastCrash delegate to underlying crashReporter

If tests fail, investigate:

1. Bridge initialization timing (should happen before wrapper is used)
2. Test fixture setup (ensure bridge is properly injected in test helpers)

Do NOT modify test-only initializer - it's intentionally preserved for test infrastructure compatibility.
</action>
<verify>
Tests pass:

```bash
make test-ios ONLY_TESTING=SentryCrashWrapperTests
```

Expected output: All tests pass, no modifications to test code required.
</verify>
<done>

- SentryCrashWrapperTests pass without modification
- Crash state properties (crashedLastLaunch, activeDurationSinceLastCrash) work correctly via bridge
- No test infrastructure changes required
  </done>
  </task>

</tasks>

<verification>
1. **Container isolation:** `grep "SentryDependencyContainer" Sources/Swift/SentryCrash/SentryCrashWrapper.swift` returns only test-only initializer reference (line ~36)
2. **Bridge usage:** crashedLastLaunch and activeDurationSinceLastCrash access bridge.crashReporter
3. **Compilation:** iOS and macOS builds succeed
4. **Tests:** SentryCrashWrapperTests pass
</verification>

<success_criteria>

- crashedLastLaunch property uses bridge.crashReporter.crashedLastLaunch (not container)
- activeDurationSinceLastCrash property uses bridge.crashReporter.activeDurationSinceLastCrash (not container)
- Only remaining container reference is test-only initializer (acceptable)
- Builds succeed on iOS and macOS
- SentryCrashWrapperTests pass without modification
  </success_criteria>

<output>
After completion, create `.planning/phases/03-objc-isolation/03-03-SUMMARY.md`
</output>
