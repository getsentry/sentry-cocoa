---
phase: 03-objc-isolation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/Sentry/include/SentryCrashInstallation.h
  - Sources/SentryCrash/Installations/SentryCrashInstallation.m
  - Sources/Sentry/Public/SentryDefines.h
autonomous: true

must_haves:
  truths:
    - "SentryCrashInstallation.m imports Sentry-Swift.h for bridge access"
    - "SentryCrashInstallation.m uses bridge.crashReporter instead of container singleton (4 references eliminated)"
    - "Bridge property accessible from SentryCrashInstallationReporter subclass"
  artifacts:
    - path: "Sources/Sentry/include/SentryCrashInstallation.h"
      provides: "Bridge property declaration on base class"
      contains: "@property (nonatomic, strong, nullable) SentryCrashBridge *bridge"
    - path: "Sources/SentryCrash/Installations/SentryCrashInstallation.m"
      provides: "Bridge usage for crashReporter access"
      min_lines: 10
  key_links:
    - from: "Sources/SentryCrash/Installations/SentryCrashInstallation.m"
      to: "bridge.crashReporter"
      via: "property access in install/uninstall/sendAllReports"
      pattern: "self\\.bridge\\.crashReporter"
---

<objective>
Inject SentryCrashBridge into SentryCrashInstallation.m to eliminate 4 SentryDependencyContainer references for crashReporter access.

Purpose: Remove container dependency from Objective-C installation base class by receiving crashReporter through bridge facade instead of singleton.

Output: SentryCrashInstallation.m uses bridge for crash handler lifecycle management, zero container imports in installation code.
</objective>

<execution_context>
@/Users/itaybrenner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itaybrenner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/PROJECT.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/ROADMAP.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/STATE.md
@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/03-objc-isolation/03-RESEARCH.md

@/Users/itaybrenner/sentry/sentry-cocoa/.planning/phases/01-facade-design-implementation/01-01-SUMMARY.md

@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Sentry/include/SentryCrashInstallation.h
@/Users/itaybrenner/sentry/sentry-cocoa/Sources/SentryCrash/Installations/SentryCrashInstallation.m
@/Users/itaybrenner/sentry/sentry-cocoa/Sources/Swift/Integrations/SentryCrash/SentryCrashBridge.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bridge property to SentryCrashInstallation base class</name>
  <files>
    Sources/Sentry/include/SentryCrashInstallation.h
    Sources/SentryCrash/Installations/SentryCrashInstallation.m
  </files>
  <action>
**SentryCrashInstallation.h:**
- Add forward declaration before @interface: `@class SentryCrashBridge;`
- Add property in @interface (after existing public interface, before @end):
  ```objc
  /** Bridge for accessing SDK services without dependency container.
   * Set by SentryCrashIntegration before installation. */
  @property (nonatomic, strong, nullable) SentryCrashBridge *bridge;
  ```

**SentryCrashInstallation.m:**

- Add import after existing imports: `#import "SentrySwift.h"` (provides SentryCrashBridge via Sentry-Swift.h)
- Locate 4 container references for crashReporter (lines ~96, 165, 176, 207 based on grep)
- Replace pattern `SentryDependencyContainer.sharedInstance.crashReporter` with:
  ```objc
  SentryCrashSwift *handler = self.bridge ? self.bridge.crashReporter
                                          : SentryDependencyContainer.sharedInstance.crashReporter;
  ```
- Use fallback pattern for backward compatibility (bridge may be nil in tests)
- Apply to all 4 locations:
  - install: method (line ~96) - crash handler setup
  - uninstall method (line ~165) - crash handler teardown
  - sendAllReportsWithCompletion: (line ~176) - report sending
  - Private helper method (line ~207) - additional crash handler access

**Why this approach:**

- Base class property makes bridge accessible to SentryCrashInstallationReporter subclass
- Property injection pattern matches SentryCrash.m approach (consistency)
- Fallback preserves test compatibility
- Public header declaration allows external initialization (SentryCrashIntegration will set it)
  </action>
  <verify>
  Compilation succeeds for iOS and macOS:

```bash
xcodebuild -scheme Sentry -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' build -quiet
xcodebuild -scheme Sentry -sdk macosx build -quiet
```

Grep confirms crashReporter accessed via bridge:

```bash
grep -n "bridge.crashReporter" Sources/SentryCrash/Installations/SentryCrashInstallation.m
```

Grep confirms bridge property in header:

```bash
grep -n "SentryCrashBridge \*bridge" Sources/Sentry/include/SentryCrashInstallation.h
```

</verify>
  <done>
- SentryCrashInstallation.h declares bridge property with forward declaration
- SentryCrashInstallation.m uses self.bridge.crashReporter with fallback to container
- All 4 crashReporter references in SentryCrashInstallation.m updated
- iOS and macOS builds succeed
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject bridge into SentryCrashInstallation from SentryCrashIntegration</name>
  <files>
    Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
  </files>
  <action>
Locate SentryCrashIntegration's initialization where SentryCrashInstallation is created.

Find where `installation` property is set (likely during init or in a setup method).

After bridge is created and after installation is created/accessed, inject bridge:

```swift
// Inject bridge into installation so it can access crashReporter
installation?.bridge = bridge
```

This must happen BEFORE calling `installation?.install(customCacheDirectory)` to ensure crash handler setup uses bridge.

**Context:** SentryCrashInstallation is likely stored as a property and initialized separately from crashReporter. Bridge injection into installation is independent of bridge injection into crashReporter (03-01).

If installation is created lazily or accessed through a getter, ensure bridge is set immediately after first access and before install() call.
</action>
<verify>
Grep confirms bridge set on installation:

```bash
grep -n "installation.*bridge = bridge" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
```

Run SentryCrashIntegrationTests:

```bash
make test-ios ONLY_TESTING=SentryCrashIntegrationTests
```

Run SentryCrashInstallation-related tests if they exist:

```bash
make test-ios ONLY_TESTING=SentryCrashInstallationReporterTests
```

</verify>
  <done>
- SentryCrashIntegration sets installation.bridge before calling install
- Bridge propagation complete: Integration â†’ SentryCrashInstallation
- Related tests pass without modification
  </done>
</task>

</tasks>

<verification>
1. **Container isolation:** `grep -r "SentryDependencyContainer" Sources/SentryCrash/Installations/SentryCrashInstallation.m` returns only fallback references (4 instances, all with bridge check)
2. **Bridge wiring:** SentryCrashInstallation.m accesses crashReporter via self.bridge when available
3. **Compilation:** iOS and macOS builds succeed
4. **Tests:** SentryCrashIntegrationTests and SentryCrashInstallationReporterTests pass
</verification>

<success_criteria>

- SentryCrashInstallation.h declares `@property (nonatomic, strong, nullable) SentryCrashBridge *bridge`
- SentryCrashInstallation.m imports Sentry-Swift.h and uses bridge.crashReporter
- SentryCrashInstallation.m has fallback to container when bridge is nil
- SentryCrashIntegration injects bridge into installation before install() call
- All 4 crashReporter accesses in SentryCrashInstallation.m updated
- Builds succeed on iOS and macOS
- Related tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/03-objc-isolation/03-02-SUMMARY.md`
</output>
