---
phase: 02-swift-isolation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/Swift/SentryCrash/SentryCrashWrapper.swift
  - Sources/Swift/SentryDependencyContainer.swift
  - Tests/SentryTests/SentryCrash/SentryCrashWrapperTests.swift
autonomous: true

must_haves:
  truths:
    - "SentryCrashWrapper receives systemInfo from bridge, not from container lazy property"
    - "SentryCrashWrapper calls bridge.activeScreenSize() instead of SentryDependencyContainerSwiftHelper"
    - "SentryCrashWrapper does not import or reference SentryDependencyContainer"
    - "Existing SentryCrashWrapper tests pass without modification"
  artifacts:
    - path: "Sources/Swift/SentryCrash/SentryCrashWrapper.swift"
      provides: "Constructor-injected bridge parameter and systemInfo initialization"
      min_lines: 50
      exports: ["SentryCrashWrapper"]
    - path: "Sources/Swift/SentryDependencyContainer.swift"
      provides: "Updated crashWrapper lazy var to pass bridge"
      contains: "bridge: bridge"
  key_links:
    - from: "Sources/Swift/SentryCrash/SentryCrashWrapper.swift"
      to: "SentryCrashBridge"
      via: "constructor parameter"
      pattern: "init.*bridge: SentryCrashBridge"
    - from: "Sources/Swift/SentryCrash/SentryCrashWrapper.swift"
      to: "bridge.crashReporter.systemInfo"
      via: "systemInfo initialization"
      pattern: "bridge\\.crashReporter\\.systemInfo"
    - from: "Sources/Swift/SentryCrash/SentryCrashWrapper.swift"
      to: "bridge.activeScreenSize()"
      via: "platform-conditional method call"
      pattern: "bridge\\.activeScreenSize\\(\\)"
---

<objective>
Refactor SentryCrashWrapper to receive dependencies through SentryCrashBridge facade instead of accessing SentryDependencyContainer singleton directly.

Purpose: Eliminate 3 of 3 container references in SentryCrashWrapper.swift (systemInfo lazy property, crashedLastLaunch, activeDurationSinceLastCrash are the ones that need bridge; activeScreenSize uses SwiftHelper which we'll also replace)
Output: SentryCrashWrapper with constructor-injected bridge, no container imports
</objective>

<execution_context>
@/Users/itaybrenner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itaybrenner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-facade-design-implementation/01-01-SUMMARY.md
@.planning/phases/01-facade-design-implementation/01-02-SUMMARY.md
@.planning/phases/02-swift-isolation/02-RESEARCH.md
@Sources/Swift/Integrations/SentryCrash/SentryCrashBridge.swift
@Sources/Swift/SentryCrash/SentryCrashWrapper.swift
@Sources/Swift/SentryDependencyContainer.swift
</context>

<tasks>

<task type="auto">
  <name>Refactor SentryCrashWrapper to accept bridge via constructor and eliminate container references</name>
  <files>
    Sources/Swift/SentryCrash/SentryCrashWrapper.swift
    Sources/Swift/SentryDependencyContainer.swift
  </files>
  <action>
**In SentryCrashWrapper.swift:**

1. Add `bridge: SentryCrashBridge` parameter to BOTH production initializers (lines 23 and 51-56)
2. Add `private let bridge: SentryCrashBridge` property (store it for activeScreenSize access)
3. Convert `lazy var systemInfo` (lines 20 and 48) to `public let systemInfo: [String: Any]` - initialize in constructor from `bridge.crashReporter.systemInfo as? [String: Any] ?? [:]`
4. Remove `SentryDependencyContainer` import if it exists
5. In `setScreenDimensions` method (line 284), replace `SentryDependencyContainerSwiftHelper.activeScreenSize()` with `bridge.activeScreenSize()`
6. Keep test-only initializer (lines 29-38) unchanged - it accepts systemInfo directly for backward compatibility with existing tests
7. Do NOT modify crashedLastLaunch or activeDurationSinceLastCrash yet (they delegate to bridge.crashReporter which still needs container - that's Phase 3)

**In SentryDependencyContainer.swift:**

1. Find the `crashWrapper` lazy var (around line 14 in Dependencies.swift or Global dependencies)
2. Update initialization to pass bridge: `SentryCrashWrapper(processInfoWrapper: processInfoWrapper, bridge: bridge)`
3. Note: This requires bridge to be available in Dependencies. The bridge is created in SentryCrashIntegration, but Dependencies.crashWrapper is used by other code paths. For now, Dependencies.crashWrapper should create its own bridge instance OR we need to check if this is only used by SentryCrashIntegration path. Check the code and handle accordingly - if Dependencies.crashWrapper is used elsewhere, create a bridge from SentryDependencyContainer.sharedInstance() services.

**Platform conditional compilation:** Keep existing `#if (os(iOS) || os(tvOS)) && !SENTRY_NO_UI_FRAMEWORK` guards around activeScreenSize call (line 281-289).

**Why these changes:** Research shows lazy property was only lazy to wait for container initialization. With constructor injection, bridge is already initialized, so property can be immutable. Test initializer preserved for backward compatibility per research Pattern 4.
</action>
<verify>

1. Build succeeds on iOS: `xcodebuild -scheme Sentry -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' build`
2. Build succeeds on macOS: `xcodebuild -scheme Sentry -sdk macosx build`
3. No grep results: `grep -n "SentryDependencyContainer" Sources/Swift/SentryCrash/SentryCrashWrapper.swift` returns empty (excluding comments)
4. Bridge property exists: `grep -n "private let bridge: SentryCrashBridge" Sources/Swift/SentryCrash/SentryCrashWrapper.swift`
5. SystemInfo is immutable: `grep -n "public let systemInfo" Sources/Swift/SentryCrash/SentryCrashWrapper.swift`
   </verify>
   <done>

- SentryCrashWrapper has `bridge: SentryCrashBridge` constructor parameter in both production initializers
- SentryCrashWrapper stores bridge as private property
- systemInfo property is immutable `let` initialized from bridge.crashReporter.systemInfo
- setScreenDimensions calls bridge.activeScreenSize() instead of SentryDependencyContainerSwiftHelper
- No SentryDependencyContainer references in SentryCrashWrapper.swift (grep returns empty)
- Test-only initializer unchanged for backward compatibility
- Dependencies/SentryDependencyContainer updated to pass bridge to crashWrapper
- iOS and macOS builds compile successfully
  </done>
  </task>

<task type="auto">
  <name>Run SentryCrashWrapper tests to verify no regressions</name>
  <files>Tests/SentryTests/SentryCrash/SentryCrashWrapperTests.swift</files>
  <action>
Run the SentryCrashWrapper test suite to verify that:
1. Test-only initializer still works (accepts systemInfo directly)
2. No test modifications needed (preserved for backward compatibility)
3. All existing tests pass

If tests fail due to production initializer being called somewhere:

- Update those specific test call sites to use test initializer OR create a mock bridge
- Do NOT change test logic or assertions

Command: `xcodebuild test -scheme Sentry -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' -only-testing:SentryTests/SentryCrashWrapperTests`
</action>
<verify>
Test output shows all SentryCrashWrapperTests passed with exit code 0
</verify>
<done>
All SentryCrashWrapper tests pass without modifications (or with minimal fixture updates for production initializer calls only)
</done>
</task>

</tasks>

<verification>
**Container isolation:** `grep -r "SentryDependencyContainer" Sources/Swift/SentryCrash/SentryCrashWrapper.swift` returns empty
**Bridge wiring:** `grep -n "bridge: SentryCrashBridge" Sources/Swift/SentryCrash/SentryCrashWrapper.swift` shows constructor parameter
**Compilation:** iOS and macOS builds succeed
**Tests:** SentryCrashWrapperTests all pass
</verification>

<success_criteria>

1. SentryCrashWrapper.swift no longer imports or references SentryDependencyContainer (grep confirms)
2. SentryCrashWrapper receives systemInfo from bridge.crashReporter.systemInfo in constructor
3. SentryCrashWrapper calls bridge.activeScreenSize() for screen dimensions (not SwiftHelper)
4. All SentryCrashWrapper tests pass without modification or with minimal fixture updates
5. iOS and macOS builds compile successfully
   </success_criteria>

<output>
After completion, create `.planning/phases/02-swift-isolation/02-01-SUMMARY.md`
</output>
