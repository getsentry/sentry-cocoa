---
phase: 02-swift-isolation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift
  - Sources/Swift/SentryDependencyContainer.swift
  - Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
  - Tests/SentryTests/Integrations/SentryCrash/SentryCrashIntegrationTests.swift
autonomous: true

must_haves:
  truths:
    - "SentryCrashIntegrationSessionHandler receives dateProvider from bridge, not from container"
    - "SentryCrashIntegrationSessionHandler does not import or reference SentryDependencyContainer"
    - "Builder method getCrashIntegrationSessionBuilder passes bridge to SessionHandler constructor"
    - "All SentryCrashIntegration tests pass without regressions"
  artifacts:
    - path: "Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift"
      provides: "Constructor-injected bridge parameter and dateProvider usage"
      min_lines: 80
      exports: ["SentryCrashIntegrationSessionHandler"]
    - path: "Sources/Swift/SentryDependencyContainer.swift"
      provides: "Updated getCrashIntegrationSessionBuilder with bridge parameter"
      contains: "bridge: SentryCrashBridge"
  key_links:
    - from: "Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift"
      to: "SentryCrashBridge"
      via: "constructor parameter"
      pattern: "init.*bridge: SentryCrashBridge"
    - from: "Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift"
      to: "bridge.dateProvider"
      via: "dateProvider access"
      pattern: "bridge\\.dateProvider"
    - from: "Sources/Swift/SentryDependencyContainer.swift"
      to: "getCrashIntegrationSessionBuilder.*bridge"
      via: "builder method signature"
      pattern: "getCrashIntegrationSessionBuilder.*bridge: SentryCrashBridge"
---

<objective>
Refactor SentryCrashIntegrationSessionHandler to receive dateProvider through SentryCrashBridge facade instead of accessing SentryDependencyContainer singleton directly.

Purpose: Eliminate 1 of 1 container reference in SentryCrashIntegrationSessionHandler.swift (dateProvider access at line 58)
Output: SessionHandler with constructor-injected bridge, no container imports
</objective>

<execution_context>
@/Users/itaybrenner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itaybrenner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-facade-design-implementation/01-01-SUMMARY.md
@.planning/phases/01-facade-design-implementation/01-02-SUMMARY.md
@.planning/phases/02-swift-isolation/02-RESEARCH.md
@Sources/Swift/Integrations/SentryCrash/SentryCrashBridge.swift
@Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift
@Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
@Sources/Swift/SentryDependencyContainer.swift
</context>

<tasks>

<task type="auto">
  <name>Add bridge parameter to SentryCrashIntegrationSessionHandler and update builder protocol</name>
  <files>
    Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift
    Sources/Swift/SentryDependencyContainer.swift
  </files>
  <action>
**In SentryCrashIntegrationSessionHandler.swift:**

1. Add `private let bridge: SentryCrashBridge` property to the class (after fileManager property)
2. Add `bridge: SentryCrashBridge` parameter to BOTH platform-conditional initializers:
   - iOS/tvOS/visionOS init (lines 18-27): Add after fileManager parameter
   - Other platforms init (lines 29-33): Add after fileManager parameter
3. In both initializers, store bridge: `self.bridge = bridge`
4. In `endCurrentSessionIfRequired` method (line 58), replace:
   `SentryDependencyContainer.sharedInstance().dateProvider.date()`
   with:
   `bridge.dateProvider.date()`
5. Remove `SentryDependencyContainer` import if it exists (not needed after this change)

**In SentryDependencyContainer.swift:**

1. Update CrashIntegrationSessionHandlerBuilder protocol (line 564):
   From: `func getCrashIntegrationSessionBuilder(_ options: Options) -> SentryCrashIntegrationSessionHandler?`
   To: `func getCrashIntegrationSessionBuilder(_ options: Options, bridge: SentryCrashBridge) -> SentryCrashIntegrationSessionHandler?`

2. Update getCrashIntegrationSessionBuilder implementation (line 271):
   - Add `bridge: SentryCrashBridge` parameter to method signature
   - Pass bridge to SessionHandler constructors:
     - iOS/tvOS/visionOS (lines 283-286): Add `bridge: bridge` after fileManager
     - Other platforms (lines 288-289): Add `bridge: bridge` after fileManager

**Why these changes:** Research Pattern 1 shows constructor injection eliminates singleton access. Research Example 2 demonstrates exact dateProvider replacement pattern.
</action>
<verify>

1. Build succeeds: `xcodebuild -scheme Sentry -sdk iphonesimulator build`
2. No container in SessionHandler: `grep -n "SentryDependencyContainer" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift` returns empty
3. Bridge property exists: `grep -n "private let bridge: SentryCrashBridge" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift`
4. Bridge usage exists: `grep -n "bridge.dateProvider" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift`
5. Protocol updated: `grep -n "getCrashIntegrationSessionBuilder.*bridge: SentryCrashBridge" Sources/Swift/SentryDependencyContainer.swift`
   </verify>
   <done>

- SentryCrashIntegrationSessionHandler has bridge property and constructor parameter
- dateProvider accessed via bridge.dateProvider instead of container singleton
- No SentryDependencyContainer references in SessionHandler
- CrashIntegrationSessionHandlerBuilder protocol includes bridge parameter
- SentryDependencyContainer implementation passes bridge to SessionHandler
- iOS build compiles successfully
  </done>
  </task>

<task type="auto">
  <name>Update SentryCrashIntegration call site to pass bridge to builder</name>
  <files>
    Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift
    Tests/SentryTests/Integrations/SentryCrash/SentryCrashIntegrationTests.swift
  </files>
  <action>
**In SentryCrashIntegration.swift:**

1. Find the call to `getCrashIntegrationSessionBuilder` (line 60)
2. Update from: `dependencies.getCrashIntegrationSessionBuilder(options)`
3. To: `dependencies.getCrashIntegrationSessionBuilder(options, bridge: bridge)`
4. Ensure this happens AFTER bridge creation (lines 53-58) - already correct per Phase 1

**In SentryCrashIntegrationTests.swift:**

1. Find MockCrashDependencies.getCrashIntegrationSessionBuilder implementation (line 788)
2. Add `bridge: SentryCrashBridge` parameter to method signature
3. Pass bridge to SessionHandler constructors (lines 796 and 802):
   - iOS/tvOS/visionOS: Add `bridge: bridge` parameter
   - Other platforms: Add `bridge: bridge` parameter

**Why these changes:** Research Pitfall 4 shows protocol conformance must match updated signature. Integration creates bridge (Phase 1 complete), now needs to pass it to builder.
</action>
<verify>

1. Build succeeds: `xcodebuild -scheme Sentry -sdk iphonesimulator build`
2. Integration passes bridge: `grep -n "getCrashIntegrationSessionBuilder(options, bridge: bridge)" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegration.swift`
3. Test mock updated: `grep -n "getCrashIntegrationSessionBuilder.*bridge: SentryCrashBridge" Tests/SentryTests/Integrations/SentryCrash/SentryCrashIntegrationTests.swift`
   </verify>
   <done>

- SentryCrashIntegration passes bridge to getCrashIntegrationSessionBuilder
- MockCrashDependencies conforms to updated protocol signature
- All call sites updated, protocol conformance maintained
- Build compiles successfully
  </done>
  </task>

<task type="auto">
  <name>Run SentryCrashIntegration tests to verify no regressions</name>
  <files>Tests/SentryTests/Integrations/SentryCrash/SentryCrashIntegrationTests.swift</files>
  <action>
Run the SentryCrashIntegration test suite to verify that:
1. SessionHandler receives bridge correctly through builder
2. dateProvider access works via bridge
3. All existing tests pass (27 tests from Phase 1 summary)

If tests fail:

- Check MockCrashDependencies bridge parameter usage
- Verify bridge is created before builder call in test fixtures
- Update test setup if needed (but do NOT change test logic)

Command: `xcodebuild test -scheme Sentry -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15' -only-testing:SentryTests/SentryCrashIntegrationTests`
</action>
<verify>
Test output shows all SentryCrashIntegrationTests passed with exit code 0
</verify>
<done>
All 27+ SentryCrashIntegration tests pass without regressions
</done>
</task>

</tasks>

<verification>
**Container isolation:** `grep -r "SentryDependencyContainer" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift` returns empty
**Bridge wiring:** `grep -n "bridge: SentryCrashBridge" Sources/Swift/Integrations/SentryCrash/SentryCrashIntegrationSessionHandler.swift` shows constructor parameter and property
**Protocol conformance:** `grep -n "getCrashIntegrationSessionBuilder.*bridge" Sources/Swift/SentryDependencyContainer.swift` shows updated signature
**Compilation:** iOS build succeeds
**Tests:** All SentryCrashIntegrationTests pass
</verification>

<success_criteria>

1. SentryCrashIntegrationSessionHandler.swift no longer imports or references SentryDependencyContainer (grep confirms)
2. SessionHandler receives dateProvider from bridge.dateProvider instead of container singleton
3. CrashIntegrationSessionHandlerBuilder protocol includes bridge parameter
4. SentryCrashIntegration passes bridge to builder method
5. All 27+ SentryCrashIntegration tests pass without regressions
6. iOS build compiles successfully
   </success_criteria>

<output>
After completion, create `.planning/phases/02-swift-isolation/02-02-SUMMARY.md`
</output>
