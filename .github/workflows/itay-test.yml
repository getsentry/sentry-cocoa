name: Test Wait for Runtimes

on:
  pull_request:

jobs:
  runtimes:
    name: Wait for Runtimes
    runs-on: ["ghcr.io/cirruslabs/macos-runner:tahoe", "runner_group_id:10"]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v5

      - name: List xcode runtimes and devices
        run: |
          xcrun simctl list runtimes -v
          xcrun simctl list devices -v

      - name: List mounted simulators
        run: |
          mount | grep CoreSimulator

      - name: Select Xcode version
        env:
          XCODE_VERSION: "26.1.1"
        run: ./scripts/ci-select-xcode.sh "$XCODE_VERSION"

      - name: List xcode runtimes and devices
        run: |
          xcrun simctl list runtimes -v
          xcrun simctl list devices -v

      - name: Wait until all devices are available
        run: |
          count=0
          while true; do
            unavailable_count=$(xcrun simctl list devices -v | grep -c "unavailable" || true)
            if [ "$unavailable_count" -eq 0 ]; then
              echo "All devices are available after $count attempts"
              break
            fi
            echo "Waiting for devices to be available... attempt $count"
            echo "Number of unavailable devices: $unavailable_count"
            echo "--------------------------------"
            xcrun simctl list devices -v | grep unavailable
            echo "--------------------------------"
            sudo launchctl kill -9 system/com.apple.CoreSimulator.simdiskimaged || true
            sudo pkill -9 com.apple.CoreSimulator.CoreSimulatorService || true
            sleep 20
            count=$((count + 1))
          done
