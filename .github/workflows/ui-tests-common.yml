name: UI Tests Common

on:
  workflow_call:
    inputs:
      fastlane_command:
        description: "The fastlane command to run"
        required: true
        type: string
      files_suffix:
        description: "Suffix for the files to upload"
        required: false
        default: ""
        type: string
      xcode_version:
        description: "Xcode version"
        required: true
        type: string
      build_with_make:
        description: "Build with make"
        required: false
        default: false
        type: boolean
      macos_version:
        description: "macOS version"
        required: true
        default: macos-26
        type: string
      needs_xcframework:
        description: "Whether the workflow needs to download the XCFramework."
        required: false
        default: false
        type: boolean
      codecov_test_analytics:
        description: "Whether or not to push results to Codecov for analytics."
        required: false
        default: false
        type: boolean
      test-destination-os:
        description: "Test destination OS"
        required: false
        default: ""
        type: string
      device:
        description: "Device"
        required: false
        default: ""
        type: string
      platform:
        description: "Additional platform to install"
        required: false
        default: ""
        type: string
      run_on_cirrus_labs:
        description: "Whether to run the tests on Cirrus Labs"
        required: false
        default: false
        type: boolean
      should_skip:
        description: "Whether to skip the job"
        required: false
        default: false
        type: boolean
    secrets:
      CODECOV_TOKEN:
        required: true

jobs:
  common-ui-tests:
    if: ${{ !inputs.should_skip }}
    name: UI Tests Common
    runs-on: ${{ inputs.run_on_cirrus_labs && fromJSON(format('["ghcr.io/cirruslabs/macos-runner:{0}", "runner_group_id:10"]', inputs.macos_version)) || inputs.macos_version }}
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v6

      - name: Setup Ruby
        uses: ruby/setup-ruby@ac793fdd38cc468a4dd57246fa9d0e868aba9085 # v1.270.0
        with:
          bundler-cache: true

      - name: Select Xcode version
        env:
          XCODE_VERSION: ${{ inputs.xcode_version }}
        run: ./scripts/ci-select-xcode.sh "$XCODE_VERSION"

      - name: Ensure required runtime is loaded
        if: ${{ inputs.platform == 'iOS' || inputs.platform == 'tvOS' }}
        # Ideally we will not need this, but CI sometimes is failing to load some runtimes, this will ensure they are loaded
        timeout-minutes: 5 # 5 minutes timeout
        env:
          OS_VERSION: ${{ inputs.test-destination-os }}
          PLATFORM: ${{ inputs.platform }}
        run: ./scripts/ci-ensure-runtime-loaded.sh --os-version "$OS_VERSION" --platform "$PLATFORM"

      # Boot created simulators to ensure they're ready before tests run
      # Based on CircleCI forum comment, booting is especially important for Xcode 26: https://discuss.circleci.com/t/xcode-26-rc/54066/18
      - name: Boot simulator
        if: ${{ inputs.platform == 'iOS' }}
        env:
          XCODE_VERSION: ${{ inputs.xcode_version }}
          DEVICE_NAME: ${{ inputs.device }}
          OS_VERSION: ${{ inputs.test-destination-os }}
        run: ./scripts/ci-boot-simulator.sh --xcode "$XCODE_VERSION" --device "$DEVICE_NAME" --os-version "$OS_VERSION"

      - run: make init-ci-build
        if: ${{ inputs.build_with_make }}

      - run: make xcode-ci
        if: ${{ inputs.build_with_make }}

      - name: Add Microphone permissions
        uses: ./.github/actions/add-microphone-permissions

      - name: Download XCFramework
        if: ${{ inputs.needs_xcframework }}
        uses: actions/download-artifact@v6
        with:
          name: xcframework-${{github.sha}}-sentry-static
          path: XCFrameworkBuildPath/

      - name: Unzip XCFramework
        if: ${{ inputs.needs_xcframework }}
        run: |
          unzip -o XCFrameworkBuildPath/Sentry.xcframework.zip -d XCFrameworkBuildPath/

      - name: Run Fastlane
        env:
          FASTLANE_COMMAND: ${{ inputs.fastlane_command }}
          DEVICE: ${{ inputs.device }}
          TEST_DESTINATION_OS: ${{ inputs.test-destination-os }}
        run: |
          if [ -n "$DEVICE" ] && [ -n "$TEST_DESTINATION_OS" ]; then
            bundle exec fastlane "$FASTLANE_COMMAND" device:"$DEVICE ($TEST_DESTINATION_OS)"
          else
            bundle exec fastlane "$FASTLANE_COMMAND"
          fi

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@e08919a3b1fb83a78393dfb775a9c37f17d8eea6 # v6.0.1
        if: always()
        with:
          report_paths: build/reports/*junit.xml
          fail_on_failure: true
          fail_on_parse_error: true
          detailed_summary: true

      - name: Codecov test analytics
        if: ${{ !cancelled() && inputs.codecov_test_analytics }}
        uses: codecov/test-results-action@47f89e9acb64b76debcd5ea40642d25a4adced9f # pin@v1.1.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true
          name: sentry-cocoa-unit-tests
          flags: ui-tests-${{ inputs.fastlane_command }}-${{ inputs.xcode_version }}, ui-tests

      - name: Upload Result Bundle
        uses: actions/upload-artifact@v6
        if: ${{ failure() }}
        with:
          name: ${{ inputs.fastlane_command }}${{ inputs.files_suffix }}
          path: |
            fastlane/test_results/**/*.xcresult

      - name: Upload iOS Simulator Crash Logs
        uses: actions/upload-artifact@v6
        if: ${{ failure() }}
        with:
          name: ${{ inputs.fastlane_command }}${{ inputs.files_suffix }}_crash_logs
          path: |
            ~/Library/Logs/DiagnosticReports/**

      - name: Archiving Raw Test Logs
        uses: actions/upload-artifact@v6
        if: ${{ failure() || cancelled() }}
        with:
          name: ${{ inputs.fastlane_command }}${{ inputs.files_suffix }}_raw_output
          path: |
            ~/Library/Logs/scan/*.log
            ./fastlane/test_output/**

      - name: Store screenshot
        uses: ./.github/actions/capture-screenshot
        if: failure()
        with:
          suffix: ${{ inputs.fastlane_command }}${{ inputs.files_suffix }}

      - name: Run CI Diagnostics
        if: failure()
        run: ./scripts/ci-diagnostics.sh
