name: Assemble XCFramework Variant

on:
  workflow_call:
    inputs:
      scheme:
        description: |-
          The Sentry project target to build an XCFramework slice for.
          Possible values: Sentry, SentrySwiftUI.
        required: true
        type: string

      suffix:
        description: |-
          The suffix to add to the build product name.
          E.g. "-Dynamic" or "-WithoutUIKitOrAppKit".
        required: false
        type: string

      configuration-suffix:
        description: |-
          The suffix to add to the build product name to build an alternate configuration of the target.
          E.g. "WithoutUIKit".
        required: false
        type: string

      variant-id:
        description: |-
          The ID of the variant to build an XCFramework slice for. Used to collect appropriate slices for final deliverable assembly.
          E.g. "sentry-static", "sentry-dynamic" or "sentry-withoutuikit-dynamic"
        required: true
        type: string

      signed:
        description: |-
          Whether or not the assembled XCFramework should be signed.
        required: false
        type: boolean
        default: false

      sdks:
        description: |-
          The SDK slices to assemble into an XCFramework.
        required: false
        type: string
        default: "iphoneos,iphonesimulator,macosx,maccatalyst,appletvos,appletvsimulator,watchos,watchsimulator,xros,xrsimulator"

      release-version:
        description: |-
          For release workflows, the version to inject into the SDK.
        required: false
        type: string

      excluded-archs:
        description: |-
          The archs to exclude from the XCFramework.
        required: false
        type: string

      override-name:
        description: |-
          The name to use for the XCFramework. If not provided, the default name will be used.
        required: false
        type: string

jobs:
  assemble-xcframework-variant:
    name: ${{ inputs.override-name || format('{0}{1}', inputs.scheme, inputs.suffix) }}

    runs-on: macos-14
    steps:
      - uses: actions/checkout@v5

      - uses: ruby/setup-ruby@v1
        if: ${{ inputs.signed }}
        with:
          bundler-cache: true

      - name: "Download Fastlane Certificate"
        if: ${{ inputs.signed }}
        run: bundle exec fastlane prepare_xcframework_signing
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY: ${{ secrets.APP_STORE_CONNECT_KEY }}
          FASTLANE_KEYCHAIN_PASSWORD: ${{ secrets.FASTLANE_KEYCHAIN_PASSWORD }}
          MATCH_GIT_PRIVATE_KEY: ${{ secrets.MATCH_GIT_PRIVATE_KEY }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_USERNAME: ${{ secrets.MATCH_USERNAME }}

      - name: Get version
        id: get-version
        env:
          RELEASE_VERSION: ${{ inputs.release-version }}
        run: |
          if [ -n "$RELEASE_VERSION" ]; then
            echo "VERSION=$RELEASE_VERSION" >> $GITHUB_ENV
          else
            echo "VERSION=$(grep MARKETING_VERSION Sources/Configuration/Versioning.xcconfig | cut -d ' ' -f 3)+${{ github.sha }}" >> $GITHUB_ENV
          fi
        shell: sh

      - name: Set XCFramework name
        id: set-xcframework-name
        env:
          OVERRIDE_NAME: ${{ inputs.override-name }}
          SCHEME: ${{ inputs.scheme }}
          SUFFIX: ${{ inputs.suffix }}
        run: |
          if [ -n "$OVERRIDE_NAME" ]; then
            echo "XCFRAMEWORK_NAME=$OVERRIDE_NAME" >> $GITHUB_ENV
          else
            echo "XCFRAMEWORK_NAME=$SCHEME$SUFFIX" >> $GITHUB_ENV
          fi

      - name: Compute cache key
        env:
          SDKS: ${{ inputs.sdks }}
          VARIANT_ID: ${{ inputs.variant-id }}
          SIGNED: ${{ inputs.signed }}
          VERSION: ${{ env.VERSION }}
        run: |
          sdks_string="$SDKS"
          sdks_string_slugified="${sdks_string//,/_}"
          echo "SENTRY_XCFRAMEWORK_CACHE_KEY=${{runner.os}}-xcframework-$VARIANT_ID-$sdks_string_slugified-$SIGNED-$VERSION-${{hashFiles('Sources/**')}}-${{hashFiles('Sentry.xcodeproj/**')}}" >> $GITHUB_ENV

      - name: Restore XCFramework cache
        id: cache-xcframework
        uses: actions/cache@v4
        with:
          key: ${{env.SENTRY_XCFRAMEWORK_CACHE_KEY}}
          path: ${{env.XCFRAMEWORK_NAME}}.xcframework.zip

      - name: Download ${{inputs.variant-id}} Slices
        if: steps.cache-xcframework.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          pattern: xcframework-${{inputs.variant-id}}-slice-*
          path: xcframework-slices

      - name: Unzip slice artifact ZIP archives
        if: steps.cache-xcframework.outputs.cache-hit != 'true'
        run: |
          find xcframework-slices -type f -print0 | xargs -t0I @ unzip @ -d xcframework-slices
        shell: bash

      - name: Remove excluded archs
        if: ${{ steps.cache-xcframework.outputs.cache-hit != 'true' && inputs.excluded-archs != '' }}
        env:
          EXCLUDED_ARCHS: ${{ inputs.excluded-archs }}
        run: ./scripts/remove-architectures.sh xcframework-slices/ "$EXCLUDED_ARCHS"
        shell: bash

      - name: Assemble XCFramework
        if: steps.cache-xcframework.outputs.cache-hit != 'true'
        env:
          SCHEME: ${{ inputs.scheme }}
          SUFFIX: ${{ inputs.suffix }}
          CONFIGURATION_SUFFIX: ${{ inputs.configuration-suffix }}
          SDKS: ${{ inputs.sdks }}
        run: ./scripts/assemble-xcframework.sh "$SCHEME" "$SUFFIX" "$CONFIGURATION_SUFFIX" "$SDKS" "/Users/runner/work/sentry-cocoa/sentry-cocoa/xcframework-slices/SDK_NAME.xcarchive"
        shell: bash

      - name: Rename XCFramework
        env:
          OVERRIDE_NAME: ${{ inputs.override-name }}
          XCFRAMEWORK_NAME: ${{ env.XCFRAMEWORK_NAME }}
          SCHEME: ${{ inputs.scheme }}
          SUFFIX: ${{ inputs.suffix }}
        if: ${{ inputs.override-name != '' }}
        run: |
          mv "${{env.SCHEME}}${{env.SUFFIX}}.xcframework" "${{env.OVERRIDE_NAME}}.xcframework"
        shell: bash

      - name: Zip XCFramework
        if: steps.cache-xcframework.outputs.cache-hit != 'true'
        env:
          SIGNED: ${{ inputs.signed }}
          SCHEME: ${{ inputs.scheme }}
          SUFFIX: ${{ inputs.suffix }}
        run: |
          if [ "$SIGNED" = "true" ]; then
            ./scripts/compress-xcframework.sh --sign "${{env.XCFRAMEWORK_NAME}}"
          else
            ./scripts/compress-xcframework.sh --not-signed "${{env.XCFRAMEWORK_NAME}}"
          fi
        shell: bash

      - name: Cache XCFramework
        uses: actions/cache@v4
        with:
          key: ${{env.SENTRY_XCFRAMEWORK_CACHE_KEY}}
          path: ${{env.XCFRAMEWORK_NAME}}.xcframework.zip

      - name: Upload XCFramework
        uses: actions/upload-artifact@v4
        with:
          overwrite: true
          name: xcframework-${{github.sha}}-${{inputs.override-name || inputs.variant-id}}
          if-no-files-found: error
          path: ${{env.XCFRAMEWORK_NAME}}.xcframework.zip
