name: lint
on:
  push:
    branches:
      - main

  pull_request:

# https://docs.github.com/en/actions/using-jobs/using-concurrency#example-using-a-fallback-value
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  files-changed:
    name: detect what files changed
    runs-on: ubuntu-22.04
    timeout-minutes: 3
    # Map a step output to a job output
    outputs:
      run_lint: ${{ steps.changes.outputs.run_lint }}
      run_swift_lint: ${{ steps.changes.outputs.run_swift_lint }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if we should run unit tests
        uses: dorny/paths-filter@0bc4621a3135347011ad047f9ecf449bf72ce2bd # v3.0.0
        id: changes
        with:
          token: ${{ github.token }}
          filters: .github/file-filters.yml

  swift-lint:
    if: needs.files-changed.outputs.run_swift_lint == 'true'
    needs: files-changed
    name: Swift Lint
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - run: swiftlint --version
      - name: Run SwiftLint
        run: swiftlint --strict

  xcode-analyze:
    if: needs.files-changed.outputs.run_lint == 'true'
    needs: files-changed
    name: Xcode Analyze
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - run: ./scripts/ci-select-xcode.sh
      - run: make analyze

  lint-podspec:
    if: needs.files-changed.outputs.run_lint == 'true'
    needs: files-changed
    name: pod lint ${{ matrix.podspec}} ${{ matrix.library_type }} ${{ matrix.platform}}
    runs-on: macos-13
    strategy:
      matrix:
        podspec: ['Sentry', 'SentrySwiftUI']
        platform: ['ios', 'macos', 'tvos', 'watchos']
        library_type: ['dynamic', 'static']

    steps:
      - uses: actions/checkout@v4
      - run: ./scripts/ci-select-xcode.sh
      # We need to update the spec-repo, because it can happen that it is not up to date and then the lint fails.
      - run: pod repo update
      - name: Validate Podspec
        run: ./scripts/pod-lib-lint.sh ${{ matrix.platform }} ${{ matrix.podspec}} ${{ matrix.library_type}}

  lint-hybrid-sdk-podspec:
    if: needs.files-changed.outputs.run_lint == 'true'
    needs: files-changed
    name: pod lint Sentry/HybridSDK
    runs-on: macos-13

    steps:
      - uses: actions/checkout@v4
      - run: ./scripts/ci-select-xcode.sh
      - run: pod repo update
      - name: Validate HybridPod Podspec
        run: pod lib lint ./Tests/HybridSDKTest/HybridPod.podspec --allow-warnings --verbose --platforms=ios "--include-podspecs={Sentry.podspec}"
