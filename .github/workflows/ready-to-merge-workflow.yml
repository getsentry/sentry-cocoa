name: Ready to Merge Workflow
on:
  workflow_call:

jobs:
  ready-to-merge-gate:
    name: 'Missing "ready-to-merge" label'
    runs-on: ubuntu-latest
    steps:
      - name: Check for exact 'ready-to-merge' label
        if: ${{ github.event_name == 'pull_request' }}
        id: check-label
        env:
          GH_TOKEN: ${{ github.token }}
          EXPECTED_LABEL: "ready-to-merge"
        run: |
          # Fetch labels from GitHub API
          # Looks like GH actions may not contain the labels in the event, so we need to fetch them from the API.
          labels=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels --jq '.[].name')
          echo "Found labels: $labels"

          # Check for exact 'ready-to-merge' label match
          if echo "$labels" | grep -q "^${{ env.EXPECTED_LABEL }}$"; then
            echo "label_found=true" >> $GITHUB_OUTPUT
          else
            echo "label_found=false" >> $GITHUB_OUTPUT
          fi
      # Since Github also accepts `skipped` results for Required Workflows, we need
      # to fail the job to ensure that the downstream jobs don't just skip.
      - name: Fail until the 'ready-to-merge' label is present
        if: ${{ github.event_name == 'pull_request' && steps.check-label.outputs.label_found == 'false' }}
        run: |
          echo "Add the 'ready-to-merge' label to run CI."
          exit 1
      - name: Gate passed
        if: ${{ github.event_name == 'pull_request' && steps.check-label.outputs.label_found == 'true' }}
        run: echo "Label present. Proceeding with CI."
      - name: Gate passed
        if: ${{ github.event_name != 'pull_request' }}
        run: echo "Not a PR. Proceeding with CI."
