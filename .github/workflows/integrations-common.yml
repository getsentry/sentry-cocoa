name: Test Integrations

on:
  workflow_call:
    inputs:
      name:
        description: "The name of the integration to test"
        required: true
        type: string
      working_directory:
        description: "The working directory to run the tests in"
        required: true
        type: string
      xcode_version:
        description: "The Xcode version to use for the job"
        required: true
        type: string
      test-destination-os:
        description: "The test destination OS to use for the job"
        required: true
        type: string
      device:
        description: "The device to test on"
        required: false
        default: ""
        type: string
      platform:
        description: "The platform to test on"
        required: true
        type: string
      package-name:
        description: "The package name to test (same as Package.swift name)"
        required: true
        type: string
      macos_version:
        description: "macOS version"
        required: true
        default: macos-26
        type: string

jobs:
  xcode-build-integrations-tests:
    name: "XCode  for Integration: ${{ inputs.name }}"
    runs-on: ${{ inputs.macos_version }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - name: Select Xcode version
        env:
          XCODE_VERSION: ${{ inputs.xcode_version }}
        run: ./scripts/ci-select-xcode.sh "$XCODE_VERSION"
      - name: Ensure required runtime is loaded
        if: ${{ inputs.platform == 'iOS' }}
        timeout-minutes: 5 # 5 minutes timeout
        env:
          OS_VERSION: ${{ inputs.test-destination-os }}
        run: ./scripts/ci-ensure-runtime-loaded.sh --os-version "$OS_VERSION"
      - name: Boot simulator
        if: ${{ inputs.platform == 'iOS' }}
        env:
          XCODE_VERSION: ${{ inputs.xcode_version }}
          DEVICE_NAME: ${{ inputs.device }}
          OS_VERSION: ${{ inputs.test-destination-os }}
        run: ./scripts/ci-boot-simulator.sh --xcode "$XCODE_VERSION" --device "$DEVICE_NAME" --os-version "$OS_VERSION"

      # We split building and running tests in two steps so we know how long running the tests takes.
      - name: Build Tests
        working-directory: ${{ inputs.working_directory }}
        env:
          PLATFORM: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          REF_NAME: ${{ github.ref_name }}
          DEVICE_NAME: ${{ inputs.device }}
          SCHEME: ${{ inputs.package-name }}
        run: |
          ../../../scripts/integration-xcodebuild.sh \
            --platform "$PLATFORM" \
            --os "$OS_VERSION" \
            --command build-for-testing \
            --device "$DEVICE_NAME" \
            --scheme "$SCHEME"

      - name: Run Tests
        working-directory: ${{ inputs.working_directory }}
        env:
          PLATFORM: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          REF_NAME: ${{ github.ref_name }}
          DEVICE_NAME: ${{ inputs.device }}
          SCHEME: ${{ inputs.package-name }}
        run: |
          ../../../scripts/integration-xcodebuild.sh \
            --platform "$PLATFORM" \
            --os "$OS_VERSION" \
            --command test-without-building \
            --device "$DEVICE_NAME" \
            --scheme "$SCHEME" \
            --result-bundle integration-results.xcresult
