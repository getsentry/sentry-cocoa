name: Unit Test Common

on:
  workflow_call:
    inputs:
      name:
        description: a descriptive job name
        required: true
        type: string

      runs-on:
        description: the runner to use for the job
        required: true
        type: string

      timeout:
        description: the timeout for the job
        required: true
        default: 20
        type: number

      should_skip:
        description: whether to skip the job
        required: false
        default: false
        type: boolean

      xcode:
        description: the Xcode version to use for the job
        required: true
        type: string

      test-destination-os:
        description: the test destination OS to use for the job
        required: true
        type: string

      platform:
        description: the platform to test on
        required: true
        type: string

      device:
        description: the device to test on
        required: false
        default: ""
        type: string

      scheme:
        description: the scheme to test
        required: true
        type: string

      run_on_cirrus_labs:
        description: "Whether to run the tests on Cirrus Labs"
        required: false
        default: false
        type: boolean

      working_directory:
        description: "The working directory to run the tests in"
        required: false
        default: "."
        type: string

      scripts_directory:
        description: "The directory containing the scripts to run"
        default: ./scripts
        required: false
        type: string

      test_spm_package:
        description: "Whether to test the SPM package"
        default: false
        required: false
        type: boolean

jobs:
  unit-tests:
    name: Unit ${{inputs.name}}
    runs-on: ${{ inputs.run_on_cirrus_labs && fromJSON(format('["ghcr.io/cirruslabs/macos-runner:{0}", "runner_group_id:10"]', inputs.runs-on)) || inputs.runs-on }}
    timeout-minutes: ${{inputs.timeout}}
    if: ${{!inputs.should_skip}}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Select Xcode version
        working-directory: ${{ inputs.working_directory }}
        env:
          XCODE_VERSION: ${{inputs.xcode}}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/ci-select-xcode.sh" "$XCODE_VERSION"

      - name: Install Slather
        run: gem install slather

      # Install platform runtimes that are not included by default
      - name: Install required platforms
        working-directory: ${{ inputs.working_directory }}
        if: ${{ inputs.install_platforms }}
        env:
          PLATFORMS: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/ci-install-platforms.sh" --platforms "$PLATFORMS" --os-version "$OS_VERSION"

      - name: Ensure required runtime is loaded
        if: ${{ inputs.platform == 'iOS' || inputs.platform == 'tvOS' || inputs.platform == 'visionOS' }}
        # Ideally we will not need this, but CI sometimes is failing to load some runtimes, this will ensure they are loaded
        timeout-minutes: 5 # 5 minutes timeout
        working-directory: ${{ inputs.working_directory }}
        env:
          OS_VERSION: ${{ inputs.test-destination-os }}
          PLATFORM: ${{ inputs.platform }}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/ci-ensure-runtime-loaded.sh" --os-version "$OS_VERSION" --platform "$PLATFORM"

      # Create simulator devices for non-preinstalled simulators
      # Required for iOS 16.4, iOS 17.5 (on Xcode 15.4), and iOS/tvOS 26.1
      - name: Create simulator device
        if: ${{ inputs.create_device }}
        working-directory: ${{ inputs.working_directory }}
        env:
          PLATFORM: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          DEVICE_NAME: ${{inputs.device}}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/ci-create-simulator.sh" --platform "$PLATFORM" --os-version "$OS_VERSION" --device-name "$DEVICE_NAME"

      # Boot created simulators to ensure they're ready before tests run
      # Based on CircleCI forum comment, booting is especially important for Xcode 26: https://discuss.circleci.com/t/xcode-26-rc/54066/18
      - name: Boot simulator
        if: ${{ (inputs.create_device && inputs.platform == 'iOS') || inputs.platform == 'visionOS' }}
        working-directory: ${{ inputs.working_directory }}
        env:
          XCODE_VERSION: ${{ inputs.xcode }}
          DEVICE_NAME: ${{ inputs.device }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          PLATFORM: ${{ inputs.platform }}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/ci-boot-simulator.sh" --xcode "$XCODE_VERSION" --device "$DEVICE_NAME" --os-version "$OS_VERSION" --platform "$PLATFORM"

      - name: Use local sentry-cocoa
        if: ${{ inputs.test_spm_package }}
        working-directory: ${{ inputs.working_directory }}
        run: swift package edit sentry-cocoa --path ../..

      # We split building and running tests in two steps so we know how long running the tests takes.
      - name: Build Tests
        working-directory: ${{ inputs.working_directory }}
        id: build_tests
        env:
          PLATFORM: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          REF_NAME: ${{ github.ref_name }}
          DEVICE_NAME: ${{ inputs.device }}
          SCHEME: ${{ inputs.scheme }}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
          TEST_SPM_PACKAGE: ${{ inputs.test_spm_package }}
        run: |
          "$SCRIPTS_DIRECTORY/sentry-xcodebuild.sh" \
            --platform "$PLATFORM" \
            --os "$OS_VERSION" \
            --ref "$REF_NAME" \
            --command build-for-testing \
            --device "$DEVICE_NAME" \
            --configuration TestCI \
            --scheme "$SCHEME" \
            $([ "$TEST_SPM_PACKAGE" = "true" ] && echo "--spm-project true")

      # Run Flaky Tests TestPlan which has a retry mechanism on failure.
      # We intentionally run these before the other test plan to fail early.
      # Use a separate result bundle name to avoid conflicts with the regular test run.
      # xcodebuild fails if a result bundle already exists at the target path.
      - name: Run Flaky Tests
        # Only the Sentry Scheme has the Flaky TestPlan.
        if: ${{ inputs.scheme == 'Sentry' }}
        working-directory: ${{ inputs.working_directory }}
        env:
          PLATFORM: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          REF_NAME: ${{ github.ref_name }}
          DEVICE_NAME: ${{ inputs.device }}
          SCHEME: ${{ inputs.scheme }}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/sentry-xcodebuild.sh" \
            --platform "$PLATFORM" \
            --os "$OS_VERSION" \
            --ref "$REF_NAME" \
            --command test-without-building \
            --device "$DEVICE_NAME" \
            --configuration TestCI \
            --scheme "$SCHEME" \
            --test-plan Sentry_Flaky \
            --result-bundle flaky-results.xcresult

      - name: Run tests
        # We call a script with the platform so the destination
        # passed to xcodebuild doesn't end up in the job name,
        # because GitHub Actions don't provide an easy way of
        # manipulating string in expressions.
        working-directory: ${{ inputs.working_directory }}
        env:
          PLATFORM: ${{ inputs.platform }}
          OS_VERSION: ${{ inputs.test-destination-os }}
          REF_NAME: ${{ github.ref_name }}
          DEVICE_NAME: ${{ inputs.device }}
          SCHEME: ${{ inputs.scheme }}
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
          TEST_SPM_PACKAGE: ${{ inputs.test_spm_package }}
        run: |
          "$SCRIPTS_DIRECTORY/sentry-xcodebuild.sh" \
            --platform "$PLATFORM" \
            --os "$OS_VERSION" \
            --ref "$REF_NAME" \
            --command test-without-building \
            --device "$DEVICE_NAME" \
            --configuration TestCI \
            --scheme "$SCHEME" \
            $([ "$TEST_SPM_PACKAGE" = "true" ] && echo "--spm-project true") \
            --result-bundle results.xcresult

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@a294a61c909bd8a4b563024a2faa28897fd53ebc # v6.1.0
        if: always()
        with:
          report_paths: "${{ inputs.working_directory }}/build/reports/junit.xml"
          fail_on_failure: true
          fail_on_parse_error: true
          detailed_summary: true

      - name: Archiving DerivedData Logs
        uses: actions/upload-artifact@v6
        if: steps.build_tests.outcome == 'failure'
        with:
          name: derived-data-${{inputs.platform}}-xcode-${{inputs.xcode}}-os-${{inputs.test-destination-os}}
          path: |
            /Users/runner/Library/Developer/Xcode/DerivedData/**/Logs/**

      - name: Archiving Raw Logs
        uses: actions/upload-artifact@v6
        if: ${{ failure() || cancelled() }}
        with:
          name: raw-output-${{inputs.platform}}-xcode-${{inputs.xcode}}-os-${{inputs.test-destination-os}}
          path: |
            raw-build-output.log
            raw-build-for-testing-output.log
            raw-test-output.log

      - name: Archiving Crash Logs
        uses: actions/upload-artifact@v6
        if: ${{ failure() || cancelled() }}
        with:
          name: crash-logs-${{inputs.platform}}-xcode-${{inputs.xcode}}-os-${{inputs.test-destination-os}}
          path: |
            ~/Library/Logs/DiagnosticReports/**

      - name: Archiving Test Results
        uses: actions/upload-artifact@v6
        if: ${{ failure() || cancelled() }}
        with:
          name: result-bundle-${{inputs.platform}}-xcode-${{inputs.xcode}}-os-${{inputs.test-destination-os}}
          path: |
            results.xcresult
            flaky-results.xcresult

      - name: Gather code coverage information via slather
        if: ${{ !inputs.test_spm_package }}
        working-directory: ${{ inputs.working_directory }}
        run: slather coverage --configuration TestCI --scheme Sentry

      # We can upload all coverage reports, because codecov merges them.
      # See https://docs.codecov.io/docs/merging-reports
      # Checkout .codecov.yml to see the config of Codecov
      # We don't upload codecov for release branches, as we don't want a failing coverage check to block a release.
      # We don't upload codecov for scheduled runs as CodeCov only accepts a limited amount of uploads per commit.
      - name: Push code coverage to codecov
        id: codecov_1
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # pin@v5.5.2
        if: ${{ contains(inputs.platform, 'iOS') && !contains(github.ref, 'release') && github.event.schedule == '' }}
        with:
          # Although public repos should not have to specify a token there seems to be a bug with the Codecov GH action, which can
          # be solved by specifying the token, see https://github.com/codecov/codecov-action/issues/557#issuecomment-1224970469
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

      # Sometimes codecov uploads etc can fail. Retry one time to rule out e.g. intermittent network failures.
      - name: Push code coverage to codecov
        id: codecov_2
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # pin@v5.5.2
        if: ${{ steps.codecov_1.outcome == 'failure' && contains(inputs.platform, 'iOS') && !contains(github.ref, 'release') && github.event.schedule == '' }}
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          verbose: true

      - name: Codecov test analytics
        if: ${{ !cancelled() && !contains(github.ref, 'release') && github.event.schedule == '' }}
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # pin@v1.2.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true
          name: sentry-cocoa-unit-tests
          flags: unittests-${{ inputs.platform }}-${{ inputs.xcode }}-${{ inputs.test-destination-os }}, unittests

      - name: Run CI Diagnostics
        if: failure()
        env:
          SCRIPTS_DIRECTORY: ${{ inputs.scripts_directory }}
        run: |
          "$SCRIPTS_DIRECTORY/ci-diagnostics.sh"

      - name: Store screenshot
        uses: ./.github/actions/capture-screenshot
        if: failure()
        with:
          suffix: unit-tests-${{ inputs.platform }}-xcode-${{ inputs.xcode }}-os-${{ inputs.test-destination-os }}
